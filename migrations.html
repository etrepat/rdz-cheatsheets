<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>migrations.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="migrations.html">migrations.rb</a>
          <a class="source" href="models.html">models.rb</a>
          <a class="source" href="queries.html">queries.rb</a>
          <a class="source" href="routing.html">routing.rb</a>
          <a class="source" href="rvm.html">rvm.rb</a>
          <a class="source" href="setup.html">setup.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>migrations.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-Línea_de_comandes'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Línea_de_comandes">&#182;</a>
        </div>
        <h3>Línea de comandes</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Generar una migració buida:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rails</span> <span class="n">g</span><span class="o">[</span><span class="n">enerate</span><span class="o">]</span> <span class="n">migration</span> <span class="no">MyNewMigration</span></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Generar una migració amb els camps</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rails</span> <span class="n">g</span><span class="o">[</span><span class="n">enerate</span><span class="o">]</span> <span class="n">migration</span> <span class="n">add_fieldname_to_tablename</span> <span class="n">fieldname</span><span class="ss">:string</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Generar una migració a partir d'un model ó scaffold</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rails</span> <span class="n">g</span><span class="o">[</span><span class="n">enerate</span><span class="o">]</span> <span class="n">model</span> <span class="no">Product</span> <span class="nb">name</span><span class="ss">:string</span> <span class="n">description</span><span class="ss">:text</span>
<span class="n">rails</span> <span class="n">g</span><span class="o">[</span><span class="n">enerate</span><span class="o">]</span> <span class="n">scaffold</span> <span class="no">Product</span> <span class="nb">name</span><span class="ss">:string</span> <span class="n">description</span><span class="ss">:text</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Executa les migracions pendents (no executades)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Executa les migracions necessàries (amunt o avall) fins a una versió específica</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rake</span> <span class="n">db</span><span class="ss">:migrate</span> <span class="no">VERSION</span><span class="o">=</span><span class="no">XXX</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Desfer els canvis realitzats en l'última migració</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rake</span> <span class="n">db</span><span class="ss">:rollback</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Desfer les 3 últimes migracions</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">rake</span> <span class="n">db</span><span class="ss">:rollback</span> <span class="no">STEP</span><span class="o">=</span><span class="mi">3</span></pre></div>
      </td>
    </tr>
    <tr id='section-Anatomia_d'una_migració'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Anatomia_d'una_migració">&#182;</a>
        </div>
        <h3>Anatomia d'una migració</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Una migració és una subclasse de <code>ActiveRecord::Migration</code> i, a partir,
de Rails 3.1 només cal que implementem el mètode <code>change</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Aquí definim els mètodes que actuaran amb la nostra base de dades d'entre
els que podem utilitzar es troben:
* <code>create_table</code>
* <code>change_table</code>
* <code>drop_table</code>
* <code>add_column</code>
* <code>change_column</code>
* <code>rename_column</code>
* <code>remove_column</code>
* <code>add_index</code>
* <code>remove_index</code>
* <code>execute</code> => per realitzar comandes SQL</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Creant_taules'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Creant_taules">&#182;</a>
        </div>
        <h3>Creant taules</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p><code>create_table</code> crea una taula. Admet com a segon paràmetre (opcional) un
hash amb algunes opcions com per exemple <code>:id =&gt; false</code> per a no
generar automàticament un camp <code>id</code> autonumeric.
Ex:</p>

<pre><code>create_table :products, :id =&gt; false do |t|
...
end
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">create_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>Els tipus de dades que tenim disponibles i, per tant, soportats per
ActiveRecord són:
<code>[:primary_key, :string, :text, :integer, :float, :decimal, :datetime,
:timestamp, :time, :date, :binary, :boolean]</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:name</span>
      <span class="n">t</span><span class="o">.</span><span class="n">string</span>  <span class="ss">:reference_number</span>
      <span class="n">t</span><span class="o">.</span><span class="n">text</span>    <span class="ss">:description</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Podem especificar valors per defecte i si un camp accepta o no null</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">float</span> <span class="ss">:price</span><span class="p">,</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Afegim un camp <code>category_id</code> per a una relació <code>belongs_to</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">belongs_to</span> <span class="ss">:category</span><span class="p">,</span> <span class="ss">:null</span> <span class="o">=&gt;</span> <span class="kp">false</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Inserta els camps automàtics <code>created_at</code> i <code>updated_at</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">timestamps</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <p>Utilitzem <code>add_index</code> per a generar índexs</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:category_id</span></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>Els índexs poden, evidentment, ser únics i afectar més d'un camp</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="o">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:reference_number</span><span class="o">]</span><span class="p">,</span> <span class="ss">:unique</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Modificant_taules'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Modificant_taules">&#182;</a>
        </div>
        <h3>Modificant taules</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">ModifyProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>Utilitzem el mètode <code>change_table</code> per a realitzar modificaciones
en una taula de forma homònima a <code>create_table</code>:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">change_table</span> <span class="ss">:products</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>elimina les columnes <code>description</code> i <code>name</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">remove</span> <span class="ss">:description</span><span class="p">,</span> <span class="ss">:name</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>afegeix la columna <code>part_number</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">string</span> <span class="ss">:part_number</span></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>crea un index en la columna <code>part_number</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">index</span> <span class="ss">:part_number</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>renombra una columna: <code>upccode</code> &ndash;> <code>upc_code</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="n">t</span><span class="o">.</span><span class="n">rename</span> <span class="ss">:upccode</span><span class="p">,</span> <span class="ss">:upc_code</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>En comptes d'utilitzar <code>change_table</code> també hauriem pogut utilitzar
els mètodes individuals. El següent executa les mateixes modificacions
que l'anterior, però és més explícit:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">ModifiyProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>eliminem les columnes <code>description</code> i <code>name</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:description</span>
    <span class="n">remove_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:name</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>afegim la columna <code>part_number</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">add_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span><span class="p">,</span> <span class="ss">:string</span></pre></div>
      </td>
    </tr>
    <tr id='section-29'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-29">&#182;</a>
        </div>
        <p>generem un índex per al camp <code>part_number</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">add_index</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:part_number</span></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>renombra una columna: <code>upccode</code> &ndash;> <code>upc_code</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">rename_column</span> <span class="ss">:products</span><span class="p">,</span> <span class="ss">:upccode</span><span class="p">,</span> <span class="ss">:upc_code</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Referències'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Referències">&#182;</a>
        </div>
        <h3>Referències</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">CreateProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>Genera automàticament una columna <code>category_id</code> del tipus adeqüat. Utilitzem
el nom del mòdel, no el de la columna.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:category</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>També podem utilizar <code>t.belongs_to :category</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>També ho podem utilizar en associacions <code>belongs_to</code> polimòrfiques i
ActiveRecord afegira les dues columnes (id i tipus).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">t</span><span class="o">.</span><span class="n">references</span> <span class="ss">:attachment</span><span class="p">,</span> <span class="ss">:polymorphic</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">&#39;Photo&#39;</span><span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p>En aquest cas es crearien les columnes <code>attachment_id</code> i <code>attachment_type</code>,
aquesta última amb el valor per defecte <code>Photo</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-SQL'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-SQL">&#182;</a>
        </div>
        <h3>SQL</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">ModifiyProducts</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
  <span class="k">def</span> <span class="nf">change</span></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p>Utiltizem <code>execute</code> per a llençar &ldquo;queries&rdquo; SQL directament. Per exemple,
per a crear una clau forània:</p>

      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">execute</span> <span class="o">&lt;&lt;-</span><span class="no">SQL</span>
<span class="sh">      ALTER TABLE products</span>
<span class="sh">        ADD CONSTRAINT fk_products_categories</span>
<span class="sh">        FOREIGN KEY (category_id)</span>
<span class="sh">        REFERENCES categories(id)</span>
<span class="no">    SQL</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
